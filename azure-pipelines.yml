# Azure DevOps Pipeline for Playwright Tests
# This pipeline runs Playwright tests on multiple browsers and environments

trigger:
  branches:
    include:
      - main
      - develop
      - feature/*
  paths:
    include:
      - tests/**
      - playwright.config.ts
      - package.json
      - azure-pipelines.yml

pr:
  branches:
    include:
      - main
      - develop
  paths:
    include:
      - tests/**
      - playwright.config.ts
      - package.json

variables:
  # Node.js version
  nodeVersion: '20.x'
  # Test result paths
  testResultsPath: '$(System.DefaultWorkingDirectory)/test-results'
  playwrightReportPath: '$(System.DefaultWorkingDirectory)/playwright-report'
  # Environment variables
  CI: true
  PLAYWRIGHT_BROWSERS_PATH: 0
  # Pipeline variables
  vmImage: 'ubuntu-latest' # Options: 'ubuntu-latest', 'windows-latest', 'macos-latest'

stages:
  - stage: Build
    displayName: 'Build and Setup'
    jobs:
      - job: Setup
        displayName: 'Setup Environment'
        pool:
          vmImage: $(vmImage)
        steps:
          - checkout: self
            displayName: 'Checkout Repository'

          - task: NodeTool@0
            displayName: 'Install Node.js'
            inputs:
              versionSpec: $(nodeVersion)

          - task: Cache@2
            displayName: 'Cache Node Modules'
            inputs:
              key: 'npm | "$(Agent.OS)" | package-lock.json'
              restoreKeys: |
                npm | "$(Agent.OS)"
              path: node_modules

          - script: |
              echo "Installing npm dependencies..."
              # Try npm ci first (faster), fallback to npm install if it fails
              npm ci || (echo "npm ci failed, cleaning and using npm install..." && rm -f package-lock.json && npm install)
            displayName: 'Install Dependencies'

          - script: |
              npx playwright install --with-deps
            displayName: 'Install Playwright Browsers'

          - script: |
              npm run clean
            displayName: 'Clean Previous Test Results'

  - stage: TestChromium
    displayName: 'Test - Chromium Browser'
    dependsOn: Build
    jobs:
      - job: ChromiumTests
        displayName: 'Run Chromium Tests'
        pool:
          vmImage: $(vmImage)
        steps:
          - checkout: self
            displayName: 'Checkout Repository'

          - task: NodeTool@0
            displayName: 'Install Node.js'
            inputs:
              versionSpec: $(nodeVersion)

          - task: Cache@2
            displayName: 'Restore Node Modules Cache'
            inputs:
              key: 'npm | "$(Agent.OS)" | package-lock.json'
              restoreKeys: |
                npm | "$(Agent.OS)"
              path: node_modules

          - script: |
              echo "Installing dependencies for Chromium tests..."
              npm ci || (echo "npm ci failed, using npm install..." && rm -f package-lock.json && npm install)
              npx playwright install chromium
            displayName: 'Install Dependencies and Chromium'

          - script: |
              npm run test:chromium
            displayName: 'Run Chromium Tests'
            continueOnError: true

          - task: PublishTestResults@2
            displayName: 'Publish Test Results'
            condition: always()
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '**/results.xml'
              searchFolder: '$(testResultsPath)'
              mergeTestResults: true
              failTaskOnFailedTests: true
              testRunTitle: 'Chromium Tests'

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Chromium HTML Report'
            condition: always()
            inputs:
              pathtoPublish: '$(playwrightReportPath)'
              artifactName: 'chromium-html-report'
              publishLocation: 'Container'

          - task: PublishPipelineArtifact@1
            displayName: 'Publish Chromium Artifacts'
            condition: always()
            inputs:
              targetPath: '$(testResultsPath)'
              artifact: 'chromium-test-results'
              publishLocation: 'pipeline'

  - stage: TestFirefox
    displayName: 'Test - Firefox Browser'
    dependsOn: Build
    condition: and(succeeded(), ne(variables['Build.Reason'], 'PullRequest'))
    jobs:
      - job: FirefoxTests
        displayName: 'Run Firefox Tests'
        pool:
          vmImage: $(vmImage)
        steps:
          - checkout: self
            displayName: 'Checkout Repository'

          - task: NodeTool@0
            displayName: 'Install Node.js'
            inputs:
              versionSpec: $(nodeVersion)

          - task: Cache@2
            displayName: 'Restore Node Modules Cache'
            inputs:
              key: 'npm | "$(Agent.OS)" | package-lock.json'
              restoreKeys: |
                npm | "$(Agent.OS)"
              path: node_modules

          - script: |
              echo "Installing dependencies for Firefox tests..."
              npm ci || (echo "npm ci failed, using npm install..." && rm -f package-lock.json && npm install)
              npx playwright install firefox
            displayName: 'Install Dependencies and Firefox'

          - script: |
              npm run test:firefox
            displayName: 'Run Firefox Tests'
            continueOnError: true

          - task: PublishTestResults@2
            displayName: 'Publish Test Results'
            condition: always()
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '**/results.xml'
              searchFolder: '$(testResultsPath)'
              mergeTestResults: true
              failTaskOnFailedTests: false
              testRunTitle: 'Firefox Tests'

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Firefox HTML Report'
            condition: always()
            inputs:
              pathtoPublish: '$(playwrightReportPath)'
              artifactName: 'firefox-html-report'
              publishLocation: 'Container'

          - task: PublishPipelineArtifact@1
            displayName: 'Publish Firefox Artifacts'
            condition: always()
            inputs:
              targetPath: '$(testResultsPath)'
              artifact: 'firefox-test-results'
              publishLocation: 'pipeline'

  - stage: TestWebKit
    displayName: 'Test - WebKit Browser'
    dependsOn: Build
    condition: and(succeeded(), ne(variables['Build.Reason'], 'PullRequest'))
    jobs:
      - job: WebKitTests
        displayName: 'Run WebKit Tests'
        pool:
          vmImage: $(vmImage)
        steps:
          - checkout: self
            displayName: 'Checkout Repository'

          - task: NodeTool@0
            displayName: 'Install Node.js'
            inputs:
              versionSpec: $(nodeVersion)

          - task: Cache@2
            displayName: 'Restore Node Modules Cache'
            inputs:
              key: 'npm | "$(Agent.OS)" | package-lock.json'
              restoreKeys: |
                npm | "$(Agent.OS)"
              path: node_modules

          - script: |
              echo "Installing dependencies for WebKit tests..."
              npm ci || (echo "npm ci failed, using npm install..." && rm -f package-lock.json && npm install)
              # Install system dependencies for WebKit on Linux
              sudo apt-get update
              sudo apt-get install -y libwoff1 libopus0 libwebp6 libwebpdemux2 libenchant-2-2 libgudev-1.0-0 libsecret-1-0 libhyphen0 libgdk-pixbuf2.0-0 libegl1 libnotify4 libxss1 libasound2
              npx playwright install webkit --with-deps
            displayName: 'Install Dependencies and WebKit'

          - script: |
              echo "Running WebKit Tests with enhanced environment..."
              # Set WebKit-specific environment variables
              export WEBKIT_HEADLESS=1
              export WEBKIT_DISABLE_COMPOSITING_DEBUG_VISUALS=1
              export DEBUG=pw:api
              npm run test:webkit
            displayName: 'Run WebKit Tests'
            continueOnError: true
            env:
              # WebKit-specific environment variables
              WEBKIT_HEADLESS: 1
              WEBKIT_DISABLE_COMPOSITING_DEBUG_VISUALS: 1
              # Increase memory limit
              NODE_OPTIONS: '--max-old-space-size=4096'

          - task: PublishTestResults@2
            displayName: 'Publish Test Results'
            condition: always()
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '**/results.xml'
              searchFolder: '$(testResultsPath)'
              mergeTestResults: true
              failTaskOnFailedTests: false
              testRunTitle: 'WebKit Tests'

          - task: PublishBuildArtifacts@1
            displayName: 'Publish WebKit HTML Report'
            condition: always()
            inputs:
              pathtoPublish: '$(playwrightReportPath)'
              artifactName: 'webkit-html-report'
              publishLocation: 'Container'

          - task: PublishPipelineArtifact@1
            displayName: 'Publish WebKit Artifacts'
            condition: always()
            inputs:
              targetPath: '$(testResultsPath)'
              artifact: 'webkit-test-results'
              publishLocation: 'pipeline'

  - stage: SmokeTests
    displayName: 'Smoke Tests'
    dependsOn: Build
    condition: eq(variables['Build.Reason'], 'PullRequest')
    jobs:
      - job: SmokeTestsJob
        displayName: 'Run Smoke Tests'
        pool:
          vmImage: $(vmImage)
        steps:
          - checkout: self
            displayName: 'Checkout Repository'

          - task: NodeTool@0
            displayName: 'Install Node.js'
            inputs:
              versionSpec: $(nodeVersion)

          - task: Cache@2
            displayName: 'Restore Node Modules Cache'
            inputs:
              key: 'npm | "$(Agent.OS)" | package-lock.json'
              restoreKeys: |
                npm | "$(Agent.OS)"
              path: node_modules

          - script: |
              echo "Installing dependencies for Smoke tests..."
              npm ci || (echo "npm ci failed, using npm install..." && rm -f package-lock.json && npm install)
              npx playwright install chromium
            displayName: 'Install Dependencies and Chromium'

          - script: |
              npm run test:smoke
            displayName: 'Run Smoke Tests'
            continueOnError: true

          - task: PublishTestResults@2
            displayName: 'Publish Smoke Test Results'
            condition: always()
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '**/results.xml'
              searchFolder: '$(testResultsPath)'
              mergeTestResults: true
              failTaskOnFailedTests: true
              testRunTitle: 'Smoke Tests'

  - stage: GenerateReport
    displayName: 'Generate Final Report'
    dependsOn: 
      - TestChromium
      - TestFirefox
      - TestWebKit
    condition: always()
    jobs:
      - job: FinalReport
        displayName: 'Generate and Publish Final Report'
        pool:
          vmImage: $(vmImage)
        steps:
          - checkout: self
            displayName: 'Checkout Repository'

          - task: NodeTool@0
            displayName: 'Install Node.js'
            inputs:
              versionSpec: $(nodeVersion)

          - script: |
              echo "Installing dependencies for report generation..."
              npm ci || (echo "npm ci failed, using npm install..." && rm -f package-lock.json && npm install)
            displayName: 'Install Dependencies'

          - task: DownloadBuildArtifacts@1
            displayName: 'Download Chromium HTML Report'
            continueOnError: true
            inputs:
              buildType: 'current'
              artifactName: 'chromium-html-report'
              downloadPath: '$(Pipeline.Workspace)/reports'

          - task: DownloadBuildArtifacts@1
            displayName: 'Download Firefox HTML Report'
            continueOnError: true
            inputs:
              buildType: 'current'
              artifactName: 'firefox-html-report'
              downloadPath: '$(Pipeline.Workspace)/reports'

          - task: DownloadBuildArtifacts@1
            displayName: 'Download WebKit HTML Report'
            continueOnError: true
            inputs:
              buildType: 'current'
              artifactName: 'webkit-html-report'
              downloadPath: '$(Pipeline.Workspace)/reports'

          - task: DownloadPipelineArtifact@2
            displayName: 'Download All Test Results'
            continueOnError: true
            inputs:
              buildType: 'current'
              targetPath: '$(Pipeline.Workspace)/test-results'

          - script: |
              echo "Generating consolidated report..."
              mkdir -p consolidated-report
              
              # Create main index page
              cat > consolidated-report/index.html << 'EOF'
              <!DOCTYPE html>
              <html>
              <head>
                  <title>Playwright Test Results - All Browsers</title>
                  <style>
                      body { font-family: Arial, sans-serif; margin: 40px; }
                      .header { background: #f5f5f5; padding: 20px; border-radius: 8px; margin-bottom: 30px; }
                      .browser-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
                      .browser-link { display: inline-block; padding: 10px 20px; margin: 5px; background: #007acc; color: white; text-decoration: none; border-radius: 5px; }
                      .browser-link:hover { background: #005999; }
                      .status { font-weight: bold; }
                      .success { color: green; }
                      .warning { color: orange; }
                      .error { color: red; }
                  </style>
              </head>
              <body>
                  <div class="header">
                      <h1>Playwright Test Results Dashboard</h1>
                      <p>Build: $BUILD_BUILDNUMBER | Branch: $BUILD_SOURCEBRANCHNAME | Date: $(date)</p>
                  </div>
              EOF
              
              # Check for each browser report and add links
              echo "<div class='browser-section'>" >> consolidated-report/index.html
              echo "<h2>Browser Test Reports</h2>" >> consolidated-report/index.html
              
              if [ -d "$(Pipeline.Workspace)/reports/chromium-html-report" ]; then
                  echo "Found Chromium report"
                  cp -r "$(Pipeline.Workspace)/reports/chromium-html-report" consolidated-report/chromium
                  echo "<p><a href='chromium/index.html' class='browser-link'>üìä Chromium Test Report</a> <span class='status success'>‚úì Available</span></p>" >> consolidated-report/index.html
              else
                  echo "<p><span class='browser-link' style='background: #ccc; color: #666;'>üìä Chromium Test Report</span> <span class='status warning'>‚ö† Not Available</span></p>" >> consolidated-report/index.html
              fi
              
              if [ -d "$(Pipeline.Workspace)/reports/firefox-html-report" ]; then
                  echo "Found Firefox report"
                  cp -r "$(Pipeline.Workspace)/reports/firefox-html-report" consolidated-report/firefox
                  echo "<p><a href='firefox/index.html' class='browser-link'>ü¶ä Firefox Test Report</a> <span class='status success'>‚úì Available</span></p>" >> consolidated-report/index.html
              else
                  echo "<p><span class='browser-link' style='background: #ccc; color: #666;'>ü¶ä Firefox Test Report</span> <span class='status warning'>‚ö† Not Available</span></p>" >> consolidated-report/index.html
              fi
              
              if [ -d "$(Pipeline.Workspace)/reports/webkit-html-report" ]; then
                  echo "Found WebKit report"
                  cp -r "$(Pipeline.Workspace)/reports/webkit-html-report" consolidated-report/webkit
                  echo "<p><a href='webkit/index.html' class='browser-link'>üåê WebKit Test Report</a> <span class='status success'>‚úì Available</span></p>" >> consolidated-report/index.html
              else
                  echo "<p><span class='browser-link' style='background: #ccc; color: #666;'>üåê WebKit Test Report</span> <span class='status warning'>‚ö† Not Available</span></p>" >> consolidated-report/index.html
              fi
              
              # Add summary information
              echo "</div>" >> consolidated-report/index.html
              echo "<div class='browser-section'>" >> consolidated-report/index.html
              echo "<h2>Test Results Summary</h2>" >> consolidated-report/index.html
              
              # Try to get test summary from JUnit files
              if [ -d "$(Pipeline.Workspace)/test-results" ]; then
                  echo "<h3>Test Execution Summary:</h3>" >> consolidated-report/index.html
                  echo "<ul>" >> consolidated-report/index.html
                  find "$(Pipeline.Workspace)/test-results" -name "*.xml" | while read xmlfile; do
                      if [ -f "$xmlfile" ]; then
                          browser=$(echo "$xmlfile" | grep -o -E "(chromium|firefox|webkit)" | head -1)
                          echo "<li>$browser: Test results available</li>" >> consolidated-report/index.html
                      fi
                  done
                  echo "</ul>" >> consolidated-report/index.html
              fi
              
              # Close HTML
              cat >> consolidated-report/index.html << 'EOF'
                  </div>
                  <div class="browser-section">
                      <h2>Additional Information</h2>
                      <p>Individual browser reports contain detailed test results, screenshots, and traces.</p>
                      <p>If a browser report is not available, check the pipeline logs for that specific browser stage.</p>
                  </div>
              </body>
              </html>
              EOF
              
              echo "Consolidated report structure:"
              find consolidated-report -type f | head -20
            displayName: 'Generate Consolidated Report'
            env:
              BUILD_BUILDNUMBER: $(Build.BuildNumber)
              BUILD_SOURCEBRANCHNAME: $(Build.SourceBranchName)

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Consolidated HTML Report'
            condition: always()
            inputs:
              pathtoPublish: 'consolidated-report'
              artifactName: 'consolidated-html-report'
              publishLocation: 'Container'

          - script: |
              echo "Test execution completed!"
              echo "Check the published reports for detailed results."
            displayName: 'Pipeline Summary'